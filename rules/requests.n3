PREFIX list: <http://www.w3.org/2000/10/swap/list#>
prefix e: <http://eulersharp.sourceforge.net/2003/03swap/log-rules#>
prefix log: <http://www.w3.org/2000/10/swap/log#>
prefix string: <http://www.w3.org/2000/10/swap/string#>
PREFIX tuner: <https://api-tuner.described.at/>
prefix file: <http://www.w3.org/2000/10/swap/file#>
prefix earl: <http://www.w3.org/ns/earl#>

{
  (?fieldName ?fieldValue) tuner:headerArg ?curlArg .
} <= {
  ( " -H '" ?fieldName ":" ?fieldValue "'" ) string:concatenation ?curlArg .
} .

{
  ?req tuner:response ?res .
} <= {
  {
    ?req a tuner:Request .
    ?req tuner:method ?method .
    ?req tuner:url ?endpointUri .
  } log:callWithOptional {
    ?req tuner:body ?body .
  } .
  ({ ?req tuner:done true } false true) log:ifThenElseIn ?SCOPE .
                                        true log:becomes { ?req tuner:done true } .

  (
    { ?req tuner:header [] . }
    {
      ( ?header { ?req tuner:header ?header } ?headers ) log:collectAllIn [] .
      ( ?headers tuner:headerArg )!list:map string:concatenation ?headersArgs .
    }
    { ?headersArgs log:equalTo "" }
  ) log:ifThenElseIn [] .

  ?endpointUri log:uri ?endpoint .

  ( ?method " " ?endpoint )!string:concatenation^tuner:trace .

  () file:temp ?responseBodyFile .
  ( ?responseBodyFile ".curl.json" ) string:concatenation ?responseHeadersFile .
  ( ?responseBodyFile ".n3" ) string:concatenation ?responseFile .

  ( "Calling " ?method " " ?endpoint )!string:concatenation^tuner:info .

  (
    "curl -s -X " ?method " '" ?endpoint "'"
    " -H 'Content-Type:text/turtle' "
    ?headersArgs
    " --data-raw $'" ?body!log:n3String "'"
    " -w @" (<>!file:basePath "../lib/curl-format.txt")!string:concatenation
    " -o " ?responseBodyFile
    " > " ?responseHeadersFile
  ) string:concatenation ?command .

  ?command^tuner:trace .
  ?command!e:exec .

  (
    "node " <>!file:basePath "../lib/merge-curl-output.js "
    ?responseBodyFile
    " > " ?responseFile
  )!string:concatenation!e:exec .

  ("file://" ?responseFile)!string:concatenation^log:uri log:semantics ?res .
  ?res^tuner:trace .

  ?responseHeadersFile!file:rm .
  ?responseBodyFile!file:rm .
  ?responseFile!file:rm .
} .
