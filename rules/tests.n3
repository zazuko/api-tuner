prefix e: <http://eulersharp.sourceforge.net/2003/03swap/log-rules#>
prefix log: <http://www.w3.org/2000/10/swap/log#>
prefix string: <http://www.w3.org/2000/10/swap/string#>
PREFIX tuner: <https://api-tuner.described.at/>
prefix file: <http://www.w3.org/2000/10/swap/file#>
prefix earl: <http://www.w3.org/ns/earl#>

{
  ( ?method ?endpointUri ) tuner:response ?res .
} <= {
  ( ?method ?endpointUri {} {} ) tuner:response ?res .
} .

{
 ( ?method ?endpointUri ?header ?body ) tuner:response ?res .
} <= {
  ({ ( ?method ?endpointUri ?header ?body ) tuner:done true } false true) log:ifThenElseIn ?SCOPE .

  ?endpointUri log:uri ?endpoint .

  ( ?method " " ?endpoint )!string:concatenation^tuner:trace .

  () file:temp ?responseBodyFile .
  ( ?responseBodyFile ".curl.json" ) string:concatenation ?responseHeadersFile .
  ( ?responseBodyFile ".n3" ) string:concatenation ?responseFile .

  (
    "curl -s -X " ?method " " ?endpoint
    " -H 'Content-Type:text/turtle' "
    " --data-raw $'" ?body!log:n3String " .'"
    " -w %{json} "
    " -o " ?responseBodyFile
    " > " ?responseHeadersFile
  ) string:concatenation ?command .

  ?command^tuner:trace .
  ?command!e:exec .

  (
    "node ../api-tuner/lib/merge-curl-output.js "
    ?responseBodyFile
    " > " ?responseFile
  )!string:concatenation!e:exec .

  ("file://" ?responseFile)!string:concatenation^log:uri log:semantics ?res .

  ?responseHeadersFile!file:rm .
  ?responseBodyFile!file:rm .
  ?responseFile!file:rm .

  true log:becomes { ( ?method ?endpointUri ?header ?body ) tuner:done true } .
} .
